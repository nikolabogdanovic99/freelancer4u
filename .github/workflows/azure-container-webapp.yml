name: Build and deploy a container to an Azure Web App 
 
env: 
  AZURE_WEBAPP_NAME: zhaw-excercise-bogdanik
 
on: 
  push: 
  workflow_dispatch 
 
permissions: 
  contents: read 
  packages: write 
 
jobs: 
  build: 
    runs-on: ubuntu-latest 
 
    steps: 
      - uses: actions/checkout@v3 
 
      - name: Set up Docker Buildx 
        uses: docker/setup-buildx-action@v3 
 
      - name: Cache Docker layers 
        uses: actions/cache@v4 
        with: 
          path: /tmp/.buildx-cache 
          key: ${{ runner.os }}-buildx-${{ github.sha }} 
          restore-keys: | 
            ${{ runner.os }}-buildx- 
 
      - name: Log in to GitHub container registry 
        uses: docker/login-action@v1.10.0 
        with: 
          registry: ghcr.io 
          username: ${{ github.actor }} 
          password: ${{ github.token }} 
 
      - name: Lowercase the repo name and username 
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV} 
 
      - name: Build and push container image to registry 
        uses: docker/build-push-action@v5 
        with: 
          push: true 
          tags: ghcr.io/${{ env.REPO }}:${{ github.sha }} 
          file: ./Dockerfile 
          platforms: linux/amd64,linux/arm64 
          cache-from: type=local,src=/tmp/.buildx-cache 
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max 
 
      - name: Persist Buildx cache 
        run: | 
          if [ -d /tmp/.buildx-cache-new ]; then 
            rm -rf /tmp/.buildx-cache 
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache 
          fi 
 
  deploy: 
    permissions: 
      contents: none 
    runs-on: ubuntu-latest 
    needs: build 
 
    steps: 
      - name: Lowercase the repo name and username 
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV} 
 
      - name: Deploy to Azure Web App 
        id: deploy-to-webapp 
        uses: azure/webapps-deploy@v2 
        with: 
          app-name: ${{ env.AZURE_WEBAPP_NAME }} 
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }} 
          images: 'ghcr.io/${{ env.REPO }}:${{ github.sha }}'